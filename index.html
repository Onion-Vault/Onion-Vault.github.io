<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Onion-Vault</title>
  <style>
    body {
      background: #f5f5f5;
      color: #111;
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    #container {
      text-align: center;
      max-width: 400px;
      margin: auto;
    }

    input, button {
      margin: 5px;
      padding: 10px;
      width: 90%;
      box-sizing: border-box;
      border: 1px solid #ccc;
      font-size: 14px;
    }

    button {
      background-color: #4CAF50;
      color: white;
      cursor: pointer;
      border: none;
    }

    button:hover {
      background-color: #45a049;
    }

    #entries {
      list-style: none;
      padding: 0;
    }
  </style>
</head>
<body>
  <div id="container">
    <h1>Onion-Vault</h1>

    <div id="login">
      <input type="text" id="username" placeholder="Username" />
      <input type="password" id="password" placeholder="Password" />
      <button onclick="login()">Log In</button>
      <button onclick="createAccount()">Create Account</button>
      <p id="status"></p>
    </div>

    <div id="vault" style="display:none;">
      <h2>Your Vault</h2>
      <ul id="entries"></ul>
      <input id="site" placeholder="Site">
      <input id="entryUsername" placeholder="Username">
      <input id="entryPassword" placeholder="Password">
      <button onclick="addEntry()">Add Entry</button>
      <button onclick="downloadVault()">Download Vault</button>
      <button onclick="logout()">Log Out</button>
    </div>
  </div>

  <script>
    let vault = [];
    let vaultKey = null;
    let currentUser = null;

    function showStatus(msg, error = false) {
      const status = document.getElementById("status");
      status.textContent = msg;
      status.style.color = error ? "tomato" : "green";
    }

    function getUserVaultKey(username) {
      return `vault-${username}`;
    }

    async function deriveKey(password) {
      const enc = new TextEncoder();
      const keyMaterial = await window.crypto.subtle.importKey(
        "raw",
        enc.encode(password),
        { name: "PBKDF2" },
        false,
        ["deriveKey"]
      );
      return window.crypto.subtle.deriveKey(
        {
          name: "PBKDF2",
          salt: enc.encode("onionvault-salt"),
          iterations: 100000,
          hash: "SHA-256"
        },
        keyMaterial,
        { name: "AES-GCM", length: 256 },
        false,
        ["encrypt", "decrypt"]
      );
    }

    async function encryptVault() {
      const iv = crypto.getRandomValues(new Uint8Array(12));
      const encoded = new TextEncoder().encode(JSON.stringify(vault));
      const ciphertext = await crypto.subtle.encrypt(
        { name: "AES-GCM", iv },
        vaultKey,
        encoded
      );
      return { ciphertext: new Uint8Array(ciphertext), iv };
    }

    async function decryptVault(encrypted, iv) {
      const decrypted = await crypto.subtle.decrypt(
        { name: "AES-GCM", iv },
        vaultKey,
        encrypted
      );
      return JSON.parse(new TextDecoder().decode(decrypted));
    }

    async function login() {
      const username = document.getElementById("username").value.trim();
      const password = document.getElementById("password").value;
      if (!username || !password) return showStatus("Enter username and password", true);

      currentUser = username;
      vaultKey = await deriveKey(password);
      const vaultData = localStorage.getItem(getUserVaultKey(username));

      if (!vaultData) {
        showStatus("Account not found. Try Create Account.", true);
        return;
      }

      try {
        const blob = JSON.parse(vaultData);
        const encrypted = Uint8Array.from(blob.ciphertext);
        const iv = Uint8Array.from(blob.iv);
        vault = await decryptVault(encrypted, iv);
        showVault();
        showStatus("Vault unlocked.");
      } catch {
        showStatus("Incorrect password or corrupted vault", true);
      }
    }

    async function createAccount() {
      const username = document.getElementById("username").value.trim();
      const password = document.getElementById("password").value;
      if (!username || !password) return showStatus("Enter username and password", true);

      const vaultKeyName = getUserVaultKey(username);
      if (localStorage.getItem(vaultKeyName)) {
        showStatus("Username already exists", true);
        return;
      }

      currentUser = username;
      vaultKey = await deriveKey(password);
      vault = [];
      await saveVault();
      showVault();
      showStatus("Account created.");
    }

    function showVault() {
      renderVault();
      document.getElementById("vault").style.display = "block";
      document.getElementById("login").style.display = "none";
    }

    function renderVault() {
      const list = document.getElementById("entries");
      list.innerHTML = "";
      vault.forEach((entry) => {
        const li = document.createElement("li");
        li.textContent = `${entry.site} | ${entry.username} | ${entry.password}`;
        list.appendChild(li);
      });
    }

    function addEntry() {
      const site = document.getElementById("site").value;
      const username = document.getElementById("entryUsername").value;
      const password = document.getElementById("entryPassword").value;
      vault.push({ site, username, password });
      renderVault();
      saveVault();
    }

    async function saveVault() {
      const { ciphertext, iv } = await encryptVault();
      const blob = JSON.stringify({ ciphertext: Array.from(ciphertext), iv: Array.from(iv) });
      localStorage.setItem(getUserVaultKey(currentUser), blob);
    }

    function downloadVault() {
      const blob = new Blob([JSON.stringify(vault, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `${currentUser}-vault.json`;
      a.click();
    }

    function logout() {
      vault = [];
      vaultKey = null;
      currentUser = null;
      document.getElementById("vault").style.display = "none";
      document.getElementById("login").style.display = "block";
      showStatus("Logged out.");
    }
  </script>
</body>
</html>
